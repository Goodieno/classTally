<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í•™ê¸‰ ì ìˆ˜íŒ (ë””ë²„ê·¸ ë²„ì „)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9fafb; margin:0; padding:20px; }
    h1 { margin-bottom:20px; }
    ul { list-style:none; padding:0; }
    li { margin:8px 0; }
    a { text-decoration:none; color:#2563eb; font-size:18px; }
    a:hover { text-decoration:underline; }
    .grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; }
    .row { display:flex; justify-content:space-between; margin-bottom:10px; align-items:center; }
    .controls { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .controls input { grid-column:span 2; padding:8px; border:1px solid #ccc; border-radius:6px; }
    .controls button { padding:8px; cursor:pointer; border:none; color:#fff; font-weight:bold; border-radius:6px; }
    .btn-add { background:#16a34a; }
    .btn-take { background:#dc2626; }
    .reasons { margin-top:10px; display:grid; gap:6px; }
    .reason { background:#fff; padding:6px 8px; border-radius:6px; font-size:14px; }
    .reason.add { color:#16a34a; font-weight:bold; }
    .reason.remove { color:#dc2626; font-weight:bold; }
    .score { font-weight:bold; }
    .back { display:inline-block; margin-bottom:16px; color:#2563eb; text-decoration:none; }
    .empty { color:#6b7280; font-size:13px; background:#fff; padding:6px 8px; border-radius:6px; }
    .reset { display:inline-block; margin-top:20px; color:#dc2626; font-weight:bold; cursor:pointer; }
  </style>
</head>
<body>
  <h1>í•™ë…„ ì„ íƒ</h1>
  <ul>
    <li><a href="#" onclick="renderGrade(1)">1í•™ë…„</a></li>
    <li><a href="#" onclick="renderGrade(2)">2í•™ë…„</a></li>
    <li><a href="#" onclick="renderGrade(3)">3í•™ë…„</a></li>
    <li><a href="#" onclick="renderGrade(4)">4í•™ë…„</a></li>
    <li><a href="#" onclick="renderGrade(5)">5í•™ë…„</a></li>
    <li><a href="#" onclick="renderGrade(6)">6í•™ë…„</a></li>
  </ul>

  <!-- Master reset double link -->
  <a href="#" class="reset" onclick="showResetConfirm()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</a>
  <span id="resetConfirm" style="display:none; margin-left:12px;">
    <a href="#" class="reset" onclick="masterReset()">âš ï¸ ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</a>
  </span>

  <div id="view"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDWrEqadNQ0ktZ9rIBG7yRequX_rstFFsE",
      authDomain: "online-tally-system.firebaseapp.com",
      databaseURL: "https://online-tally-system-default-rtdb.firebaseio.com",
      projectId: "online-tally-system",
      storageBucket: "online-tally-system.appspot.com",
      messagingSenderId: "89585597340",
      appId: "1:89585597340:web:989e55802c4ebf68f6e659",
      measurementId: "G-ZWWG5EH8C8"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.auth().signInAnonymously();

    const db = firebase.database();
    const view = document.getElementById("view");

    function renderGrade(grade) {
      view.innerHTML = `<a href="#" class="back" onclick="goHome()">â† í•™ë…„ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                        <h2>${grade}í•™ë…„ í•™ê¸‰ ì ìˆ˜íŒ</h2>
                        <div id="classesGrid" class="grid"></div>`;
      const grid = document.getElementById("classesGrid");

      for (let c = 1; c <= 8; c++) {
        const classKey = `${grade}í•™ë…„-${c}ë°˜`;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="row">
            <div>${classKey}</div>
            <div id="${classKey}-score"><strong>ì´ì : 0</strong></div>
          </div>
          <div class="controls">
            <input type="text" placeholder="ì´ìœ  ì…ë ¥" id="${classKey}-reason"/>
            <button class="btn-add" id="${classKey}-add">+ ì ìˆ˜ ì¶”ê°€</button>
            <button class="btn-take" id="${classKey}-take">âˆ’ ì ìˆ˜ ì°¨ê°</button>
          </div>
          <div class="reasons" id="${classKey}-reasons">
            <div class="empty">ìµœê·¼ ì´ìœ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
        `;
        grid.appendChild(card);

        const reasonInput = document.getElementById(`${classKey}-reason`);
        const addBtn = document.getElementById(`${classKey}-add`);
        const takeBtn = document.getElementById(`${classKey}-take`);
        const scoreEl = document.getElementById(`${classKey}-score`);
        const reasonsDiv = document.getElementById(`${classKey}-reasons`);

        db.ref(`classes/${classKey}/points`).on("value", snap => {
          scoreEl.innerHTML = `<strong>ì´ì : ${snap.val() ?? 0}</strong>`;
        });

        db.ref(`classes/${classKey}/log`).on("value", snap => {
          reasonsDiv.innerHTML = "";
          if (!snap.exists()) {
            reasonsDiv.innerHTML = `<div class="empty">ìµœê·¼ ì´ìœ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          } else {
            const entries = [];
            snap.forEach(child => entries.push({ ...child.val(), key: child.key }));
            entries.sort((a,b) => b.ts - a.ts);   // newest first
            const last3 = entries.slice(0,3);     // âœ… latest 3
            last3.forEach(e => {
              const div = document.createElement("div");
              div.className = `reason ${e.type}`; // "add" or "remove"
              div.textContent = (e.type === "add" ? "+" : "âˆ’") + e.amount + "ì : " + e.reason;
              reasonsDiv.appendChild(div);
            });
          }
        });

        addBtn.onclick = () => {
          const reason = reasonInput.value.trim() || "ì´ìœ  ì—†ìŒ";
          saveChange(classKey, +2, reason);
          reasonInput.value = "";
        };

        takeBtn.onclick = () => {
          const reason = reasonInput.value.trim() || "ì´ìœ  ì—†ìŒ";
          saveChange(classKey, -1, reason);
          reasonInput.value = "";
        };
      }
    }

    function saveChange(classKey, delta, reason) {
      const ref = db.ref(`classes/${classKey}`);
      const logRef = ref.child("log");

      ref.child("points").transaction(p => (p || 0) + delta);

      const entry = {
        type: delta > 0 ? "add" : "remove",
        amount: Math.abs(delta),
        reason,
        ts: Date.now()
      };

      const newLog = logRef.push();
      newLog.set(entry).then(() => {
        const undoBtn = document.createElement("button");
        undoBtn.textContent = "â†©ï¸ ë˜ëŒë¦¬ê¸°";
        undoBtn.style = "margin-top:8px; padding:6px; background:#facc15; border:none; border-radius:6px; font-weight:bold;";
        undoBtn.onclick = () => {
          newLog.remove();
          ref.child("points").transaction(p => (p || 0) - delta);
          undoBtn.remove();
        };
        const reasonsDiv = document.getElement
