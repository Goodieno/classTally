<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Class Tally</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
}

a { text-decoration: none; }

button {
  cursor: pointer;
  padding: 6px 10px;
  margin: 2px;
}

.admin-btn {
  position: fixed;
  top: 10px;
  right: 10px;
}

/* HOME */
#grade-links li {
  font-size: 20px;
  margin: 10px 0;
}

/* GRID */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  max-width: 900px;
  margin: auto;
  gap: 15px;
  justify-content: center;
}

/* CARD */
.card {
  border: 1px solid #ccc;
  padding: 12px;
  border-radius: 6px;
}

.class-name {
  color: #1d4ed8;
  font-weight: bold;
  font-size: 18px;
}

.points {
  color: #14532d;
  font-weight: bold;
  font-size: 22px;
}

/* REASONS */
.reasons {
  background: #f3f4f6;
  padding: 6px;
  margin-top: 6px;
  max-height: 90px;
  overflow-y: auto;
}

.reason.plus {
  color: #14532d;
  font-weight: bold;
}

.reason.minus {
  color: #b91c1c;
  font-weight: bold;
}

/* ‚úÖ TIMESTAMP ‚Äî SMALL + BLACK */
.reason-time {
  font-size: 10px;
  color: #000;
  opacity: 0.7;
  margin-left: 4px;
}

/* BADGES */
.badge {
  margin-left: 6px;
}
</style>
</head>

<body>

<button class="admin-btn" onclick="goAdmin()">Admin</button>

<div id="app"></div>

<script>
/* üî• FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDWrEqadNQ0ktZ9rIBG7yRequX_rstFFsE",
  authDomain: "online-tally-system.firebaseapp.com",
  databaseURL: "https://online-tally-system-default-rtdb.firebaseio.com",
  projectId: "online-tally-system",
  storageBucket: "online-tally-system.firebasestorage.app",
  messagingSenderId: "89585597340",
  appId: "1:89585597340:web:989e55802c4ebf68f6e659"
});

const db = firebase.database();
let lastUndo = null;

/* ROUTER */
function router() {
  const hash = location.hash;
  if (hash.startsWith("#grade")) renderGrade(hash.split("-")[1]);
  else if (hash === "#admin") renderAdmin();
  else renderHome();
}
window.onhashchange = router;

/* HOME */
function renderHome() {
  app.innerHTML = `<ul id="grade-links"></ul>`;
  const ul = document.getElementById("grade-links");

  for (let g = 1; g <= 6; g++) {
    const li = document.createElement("li");
    ul.appendChild(li);

    db.ref(`grades/${g}`).off();
    db.ref(`grades/${g}`).on("value", snap => {
      let max = 0;
      let leaders = [];

      snap.forEach(c => {
        const p = c.val().points || 0;
        if (p > max) {
          max = p;
          leaders = [c.key];
        } else if (p === max && p > 0) {
          leaders.push(c.key);
        }
      });

      let label = "";
      if (max > 0) {
        label = leaders.length > 1
          ? ` <span class="badge">ü•ä TIE</span> ${leaders.join(", ")}Î∞ò (${max})`
          : ` <span class="badge">üëë</span> ${leaders[0]}Î∞ò (${max})`;
      }

      li.innerHTML = `<a href="#grade-${g}">${g}ÌïôÎÖÑ</a>${label}`;
    });
  }
}

/* GRADE PAGE */
function renderGrade(g) {
  app.innerHTML = `
    <h2>${g}ÌïôÎÖÑ</h2>
    <div class="grid" id="grid"></div>
    <button onclick="location.hash=''">‚Üê Home</button>
  `;

  const grid = document.getElementById("grid");
  db.ref(`grades/${g}`).off();
  db.ref(`grades/${g}`).on("value", snap => {
    grid.innerHTML = "";
    snap.forEach(c => {
      const data = c.val();
      const card = document.createElement("div");
      card.className = "card";

      const reasonsHTML = (data.reasons || []).slice(-3).map(r => `
        <div class="reason ${r.delta > 0 ? 'plus' : 'minus'}">
          ${r.text}
          <span class="reason-time">(${r.time})</span>
        </div>
      `).join("");

      card.innerHTML = `
        <div class="class-name">${c.key}Î∞ò</div>
        <div class="points">${data.points || 0}</div>
        <div class="reasons">${reasonsHTML}</div>

        <input placeholder="Reason" id="r-${g}-${c.key}">
        <button onclick="addPoint(${g},'${c.key}',2)">+2</button>
        <button onclick="addPoint(${g},'${c.key}',-1)">-1</button>
        ${lastUndo ? `<button onclick="undo()">Undo</button>` : ""}
      `;
      grid.appendChild(card);
    });
  });
}

/* ADD POINT */
function addPoint(g, c, delta) {
  const input = document.getElementById(`r-${g}-${c}`);
  const text = input.value.trim();
  if (!text) return;

  const now = new Date();
  const time =
    String(now.getMonth() + 1).padStart(2, "0") + "." +
    String(now.getDate()).padStart(2, "0") + " " +
    String(now.getHours()).padStart(2, "0") + ":" +
    String(now.getMinutes()).padStart(2, "0");

  const ref = db.ref(`grades/${g}/${c}`);
  ref.transaction(d => {
    d ||= { points: 0, reasons: [] };
    d.points += delta;
    d.reasons.push({ text, delta, time });
    lastUndo = { g, c, delta };
    return d;
  });

  input.value = "";
}

/* UNDO (session only) */
function undo() {
  if (!lastUndo) return;
  const { g, c, delta } = lastUndo;
  const ref = db.ref(`grades/${g}/${c}`);
  ref.transaction(d => {
    d.points -= delta;
    d.reasons.pop();
    return d;
  });
  lastUndo = null;
}

/* ADMIN */
function renderAdmin() {
  const pw = prompt("Password:");
  if (pw !== "delete") return location.hash = "";

  app.innerHTML = `<h2>Admin Panel</h2>`;
  for (let g = 1; g <= 6; g++) {
    app.innerHTML += `<button onclick="clearGrade(${g})">${g}ÌïôÎÖÑ Ï¥àÍ∏∞Ìôî</button><br>`;
  }
  app.innerHTML += `<br><button onclick="location.hash=''">Home</button>`;
}

function clearGrade(g) {
  if (!confirm("Ï†ïÎßê ÏÇ≠Ï†ú?")) return;
  db.ref(`grades/${g}`).remove();
}

function goAdmin() {
  location.hash = "#admin";
}

router();
</script>

</body>
</html>
