<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Class Tally</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
a { text-decoration: none; }
button { cursor: pointer; padding: 6px 10px; }
.admin-btn { position: fixed; top: 10px; right: 10px; }
#grade-links li { font-size: 20px; margin: 10px 0; }
.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); max-width: 900px; margin: auto; gap: 15px; justify-content: center; }
.card { border: 1px solid #ccc; padding: 12px; border-radius: 6px; }
.class-name { color: #1d4ed8; font-weight: bold; font-size: 18px; }
.points { color: #14532d; font-weight: bold; font-size: 22px; }
.reasons { background: #f3f4f6; padding: 6px; margin-top: 6px; max-height: 90px; overflow-y: auto; }
.reason.plus { color: #14532d; font-weight: bold; }
.reason.minus { color: #b91c1c; font-weight: bold; }
.reason-time { font-size: 11px; opacity: 0.7; }
.badge { margin-left: 6px; }
</style>
</head>

<body>
<button class="admin-btn" onclick="goAdmin()">ê´€ë¦¬ì</button>
<div id="app"></div>

<script>
/* ğŸ”¥ Firebase setup */
firebase.initializeApp({
  apiKey: "AIzaSyDWrEqadNQ0ktZ9rIBG7yRequX_rstFFsE",
  authDomain: "online-tally-system.firebaseapp.com",
  databaseURL: "https://online-tally-system-default-rtdb.firebaseio.com",
  projectId: "online-tally-system",
  storageBucket: "online-tally-system.firebasestorage.app",
  messagingSenderId: "89585597340",
  appId: "1:89585597340:web:989e55802c4ebf68f6e659"
});

const db = firebase.database();
let lastUndo = null;

/* ğŸ”¹ Ensure grades exist (safe, won't overwrite classes) */
function restoreGrades() {
  for (let g = 1; g <= 6; g++) {
    const gradeRef = db.ref(`grades/${g}`);
    gradeRef.once("value").then(snapshot => {
      if (!snapshot.exists()) {
        const defaultClasses = { "Aë°˜": 0, "Bë°˜": 0 };
        gradeRef.set(defaultClasses);
        console.log(`${g}í•™ë…„ ì´ˆê¸°í™” ì™„ë£Œ`);
      }
    });
  }
}
restoreGrades();

/* Router */
function router() {
  const hash = location.hash;
  if (hash.startsWith("#grade")) renderGrade(hash.split("-")[1]);
  else if (hash === "#admin") renderAdmin();
  else renderHome();
}
window.onhashchange = router;

/* HOME page: show leading class per grade */
function renderHome() {
  app.innerHTML = `<ul id="grade-links"></ul>`;
  const ul = document.getElementById("grade-links");

  for (let g = 1; g <= 6; g++) {
    const li = document.createElement("li");
    ul.appendChild(li);

    db.ref(`grades/${g}`).off();
    db.ref(`grades/${g}`).on("value", snap => {
      let max = 0;
      let leaders = [];

      snap.forEach(c => {
        const p = c.val() || 0;
        if (p > max) { max = p; leaders = [c.key]; }
        else if (p === max && p > 0) leaders.push(c.key);
      });

      let label = "";
      if (max > 0) {
        label = leaders.length > 1
          ? ` <span class="badge">ğŸ¥Š ë™ì </span> ${leaders.join(", ")}`
          : ` <span class="badge">ğŸ‘‘</span> ${leaders[0]}`;
      }

      li.innerHTML = `<a href="#grade-${g}">${g}í•™ë…„</a>${label}`;
    });
  }
}

/* GRADE page: show each class with details */
function renderGrade(g) {
  app.innerHTML = `
    <h2>${g}í•™ë…„</h2>
    <div class="grid" id="grid"></div>
    <button onclick="location.hash=''">â† í™ˆìœ¼ë¡œ</button>
  `;
  const grid = document.getElementById("grid");

  db.ref(`classes/${g}`).off();
  db.ref(`classes/${g}`).on("value", snap => {
    grid.innerHTML = "";
    snap.forEach(c => {
      const data = c.val();
      const card = document.createElement("div");
      card.className = "card";

      const reasons = (data.reasons || []).slice(-3).map(r =>
        `<div class="reason ${r.delta>0?'plus':'minus'}">
          ${r.text} <span class="reason-time">(${r.time})</span>
        </div>`
      ).join("");

      card.innerHTML = `
        <div class="class-name">${c.key}</div>
        <div class="points">${data.points || 0}</div>
        <div class="reasons">${reasons}</div>
        <input placeholder="ì‚¬ìœ  ì…ë ¥" id="r-${g}-${c.key}">
        <button onclick="addPoint(${g},'${c.key}',1)">+1ì </button>
        <button onclick="addPoint(${g},'${c.key}',-1)">-1ì </button>
        ${lastUndo ? `<button onclick="undo()">ì‹¤í–‰ ì·¨ì†Œ</button>` : ""}
      `;
      grid.appendChild(card);
    });
  });
}

/* Add/subtract points: updates both classes and grades */
function addPoint(grade, cls, delta) {
  const input = document.getElementById(`r-${grade}-${cls}`);
  const text = input.value.trim();
  if (!text) return;

  const time = new Date().toLocaleString("ko-KR",{ month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });

  const classRef = db.ref(`classes/${grade}/${cls}`);
  classRef.transaction(d => {
    d ||= { points:0, reasons:[] };
    d.points += delta;
    d.reasons.push({ text, delta, time });
    lastUndo = { grade, cls, delta };
    return d;
  }).then(() => {
    classRef.once("value").then(snap => {
      const points = snap.val().points || 0;
      db.ref(`grades/${grade}/${cls}`).set(points);
    });
  });

  input.value = "";
}

/* Undo last action */
function undo() {
  if (!lastUndo) return;
  const { grade, cls, delta } = lastUndo;
  const classRef = db.ref(`classes/${grade}/${cls}`);
  classRef.transaction(d => {
    d.points -= delta;
    d.reasons.pop();
    return d;
  }).then(() => {
    classRef.once("value").then(snap => {
      const points = snap.val().points || 0;
      db.ref(`grades/${grade}/${cls}`).set(points);
    });
  });
  lastUndo = null;
}

/* Admin panel */
function renderAdmin() {
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
  if (pw !== "delete") return location.hash = "";

  app.innerHTML = `<h2>ê´€ë¦¬ì íŒ¨ë„</h2>`;
  for(let g=1; g<=6; g++){
    app.innerHTML += `<button onclick="clearGrade(${g})">${g}í•™ë…„ ì´ˆê¸°í™”</button><br>`;
  }
  app.innerHTML += `<br><button onclick="location.hash=''">í™ˆìœ¼ë¡œ</button>`;
}

function clearGrade(g){
  if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  db.ref(`classes/${g}`).remove();
  db.ref(`grades/${g}`).remove();
}

function goAdmin(){ location.hash="#admin"; }

router();
</script>

</body>
</html>
