<!-- Firebase SDKs (CDN compat version) -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDWrEqadNQ0ktZ9rIBG7yRequX_rstFFsE",
    authDomain: "online-tally-system.firebaseapp.com",
    databaseURL: "https://online-tally-system-default-rtdb.firebaseio.com",
    projectId: "online-tally-system",
    storageBucket: "online-tally-system.appspot.com",
    messagingSenderId: "89585597340",
    appId: "1:89585597340:web:989e55802c4ebf68f6e659",
    measurementId: "G-ZWWG5EH8C8"
  };

  try {
    firebase.initializeApp(firebaseConfig);
    console.log("[Firebase] Initialized");
  } catch (e) {
    console.error("[Firebase Init Error]", e);
  }

  firebase.auth().signInAnonymously()
    .then(() => console.log("[Auth] Signed in anonymously"))
    .catch(err => console.error("[Auth Error]", err));

  const db = firebase.database();
  const view = document.getElementById("view");

  function renderGrade(grade) {
    view.innerHTML = `<a href="#" class="back" onclick="goHome()">← 학년으로 돌아가기</a>
                      <h2>${grade}학년 학급 점수판</h2>
                      <div id="classesGrid" class="grid"></div>`;
    const grid = document.getElementById("classesGrid");

    for (let c = 1; c <= 8; c++) {
      const classKey = `${grade}학년-${c}반`;
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="row">
          <div>${classKey}</div>
          <div id="${classKey}-score">총점: 0</div>
        </div>
        <div class="controls">
          <input type="text" placeholder="이유 입력" id="${classKey}-reason"/>
          <button class="btn-add" id="${classKey}-add">+ 점수 추가</button>
          <button class="btn-take" id="${classKey}-take">− 점수 차감</button>
        </div>
        <div class="reasons" id="${classKey}-reasons">
          <div class="empty">최근 이유가 없습니다.</div>
        </div>
      `;
      grid.appendChild(card);

      const reasonInput = document.getElementById(`${classKey}-reason`);
      const addBtn = document.getElementById(`${classKey}-add`);
      const takeBtn = document.getElementById(`${classKey}-take`);
      const scoreEl = document.getElementById(`${classKey}-score`);
      const reasonsDiv = document.getElementById(`${classKey}-reasons`);

      db.ref(`classes/${classKey}/points`).on("value", snap => {
        const val = snap.val();
        scoreEl.textContent = `총점: ${val ?? 0}`;
      });

      db.ref(`classes/${classKey}/log`).on("value", snap => {
        reasonsDiv.innerHTML = "";
        if (!snap.exists()) {
          reasonsDiv.innerHTML = `<div class="empty">최근 이유가 없습니다.</div>`;
        } else {
          const entries = [];
          snap.forEach(child => entries.push({ ...child.val(), key: child.key }));
          entries.sort((a,b) => b.ts - a.ts);
          const last3 = entries.slice(0,3);
          last3.forEach(e => {
            const div = document.createElement("div");
            div.className = `reason ${e.type}`;
            div.textContent = (e.type==="add" ? "+" : "−") + e.amount + "점: " + e.reason;
            reasonsDiv.appendChild(div);
          });
        }
      });

      addBtn.onclick = () => {
        const reason = reasonInput.value.trim() || "이유 없음";
        saveChange(classKey, +2, reason);
        reasonInput.value = "";
      };

      takeBtn.onclick = () => {
        const reason = reasonInput.value.trim() || "이유 없음";
        saveChange(classKey, -1, reason);
        reasonInput.value = "";
      };
    }
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function saveChange(classKey, delta, reason) {
    const ref = db.ref(`classes/${classKey}`);
    const logRef = ref.child("log");

    ref.child("points").transaction(p => (p || 0) + delta);

    const entry = {
      type: delta > 0 ? "add" : "remove",
      amount: Math.abs(delta),
      reason,
      ts: Date.now()
    };

    const newLog = logRef.push();
    newLog.set(entry)
      .then(() => {
        const undoBtn = document.createElement("button");
        undoBtn.textContent = "↩️ 되돌리기";
        undoBtn.style = "margin-top:8px; padding:6px; background:#facc15; border:none; border-radius:6px; font-weight:bold;";
        undoBtn.onclick = () => {
          newLog.remove();
          ref.child("points").transaction(p => (p || 0) - delta);
          undoBtn.remove();
        };
        const reasonsDiv = document.getElementById(`${classKey}-reasons`);
        reasonsDiv.appendChild(undoBtn);
      });
  }

  function goHome() {
    view.innerHTML = "";
  }
</script>
