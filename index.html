<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDWrEqadNQ0ktZ9rIBG7yRequX_rstFFsE",
    authDomain: "online-tally-system.firebaseapp.com",
    databaseURL: "https://online-tally-system-default-rtdb.firebaseio.com",
    projectId: "online-tally-system",
    storageBucket: "online-tally-system.appspot.com",
    messagingSenderId: "89585597340",
    appId: "1:89585597340:web:989e55802c4ebf68f6e659",
    measurementId: "G-ZWWG5EH8C8"
  };

  firebase.initializeApp(firebaseConfig);
  firebase.auth().signInAnonymously();

  const db = firebase.database();
  const view = document.getElementById("view");

  function goHome() {
    view.innerHTML = "";
    window.scrollTo(0, 0);
  }

  function renderGrade(grade) {
    view.innerHTML = `
      <a href="#" class="back" onclick="goHome(); return false;">â† í•™ë…„ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      <h2><strong>${grade}í•™ë…„ í•™ê¸‰ ì ìˆ˜íŒ</strong></h2>
      <div id="classesGrid" class="grid"></div>
    `;
    const grid = document.getElementById("classesGrid");

    for (let c = 1; c <= 8; c++) {
      const classKey = `${grade}í•™ë…„-${c}ë°˜`;
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="row">
          <div><strong>${classKey}</strong></div>
          <div id="${cssId(classKey)}-score"><strong>ì´ì : 0</strong></div>
        </div>
        <div class="controls">
          <input type="text" placeholder="ì´ìœ  ì…ë ¥" id="${cssId(classKey)}-reason" />
          <button class="btn-add" id="${cssId(classKey)}-add">+ ì ìˆ˜ ì¶”ê°€</button>
          <button class="btn-take" id="${cssId(classKey)}-take">âˆ’ ì ìˆ˜ ì°¨ê°</button>
        </div>
        <div class="reasons" id="${cssId(classKey)}-reasons">
          <div class="empty">ìµœê·¼ ì´ìœ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      `;
      grid.appendChild(card);

      const reasonInput = document.getElementById(`${cssId(classKey)}-reason`);
      const addBtn = document.getElementById(`${cssId(classKey)}-add`);
      const takeBtn = document.getElementById(`${cssId(classKey)}-take`);
      const scoreEl = document.getElementById(`${cssId(classKey)}-score`);
      const reasonsDiv = document.getElementById(`${cssId(classKey)}-reasons`);

      db.ref(`classes/${classKey}/points`).on("value", snap => {
        scoreEl.innerHTML = `<strong>ì´ì : ${snap.val() ?? 0}</strong>`;
      });

      // Show latest 3 reasons
      db.ref(`classes/${classKey}/log`).limitToLast(3).on("value", snap => {
        reasonsDiv.innerHTML = "";
        if (!snap.exists()) {
          reasonsDiv.innerHTML = `<div class="empty">ìµœê·¼ ì´ìœ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          return;
        }
        const items = [];
        snap.forEach(child => items.push(child.val()));
        items.reverse();
        items.forEach(e => {
          const div = document.createElement("div");
          div.className = `reason ${e.type}`;
          div.innerHTML = `<strong>${e.type === "add" ? "+" : "âˆ’"}${e.amount}ì </strong>: ${escapeHtml(e.reason || "ì´ìœ  ì—†ìŒ")}`;
          reasonsDiv.appendChild(div);
        });
      });

      addBtn.onclick = () => {
        const reason = (reasonInput.value || "").trim() || "ì´ìœ  ì—†ìŒ";
        saveChange(classKey, +2, reason);
        reasonInput.value = "";
      };

      takeBtn.onclick = () => {
        const reason = (reasonInput.value || "").trim() || "ì´ìœ  ì—†ìŒ";
        saveChange(classKey, -1, reason);
        reasonInput.value = "";
      };
    }
  }

  function saveChange(classKey, delta, reason) {
    const ref = db.ref(`classes/${classKey}`);
    const logRef = ref.child("log");
    ref.child("points").transaction(p => (p || 0) + delta);
    const entry = {
      type: delta > 0 ? "add" : "remove",
      amount: Math.abs(delta),
      reason,
      ts: Date.now()
    };
    logRef.push(entry);
  }

  function renderAdmin() {
    view.innerHTML = `
      <a href="#" class="back" onclick="goHome(); return false;">â† í•™ë…„ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      <h2><strong>ê´€ë¦¬ì ë©”ë‰´</strong></h2>
      <button class="reset" onclick="masterReset(); return false;">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
    `;
  }

  function masterReset() {
    if (!confirm("ì •ë§ ëª¨ë“  í•™ê¸‰ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    for (let g = 1; g <= 6; g++) {
      for (let c = 1; c <= 8; c++) {
        const classKey = `${g}í•™ë…„-${c}ë°˜`;
        const ref = db.ref(`classes/${classKey}`);
        ref.child("points").set(0);
        ref.child("log").set(null);
      }
    }
    alert("ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ!");
  }

  // Helpers
  function cssId(s) {
    return s.replace(/\s+/g, "_");
  }
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Attach functions globally
  window.renderGrade = renderGrade;
  window.renderAdmin = renderAdmin;
  window.masterReset = masterReset;
  window.goHome = goHome;
</script>
