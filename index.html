<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Class Tally</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
}

/* Links and buttons */
a { text-decoration: none; color: #2563eb; }
button { cursor: pointer; padding: 6px 10px; margin: 3px; }

/* Admin button */
.admin-btn { position: fixed; top: 10px; right: 10px; }

/* Home page */
#grade-links li { font-size: 20px; margin: 10px 0; }

/* Grid layout */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  max-width: 900px;
  margin: auto;
  gap: 15px;
  justify-content: center;
}

/* Card */
.card {
  border: 1px solid #ccc;
  padding: 12px;
  border-radius: 6px;
}

/* Class name & points */
.class-name { color: #1d4ed8; font-weight: bold; font-size: 18px; }
.points { color: #14532d; font-weight: bold; font-size: 22px; }

/* Reasons scroll */
.reasons {
  background: #f3f4f6;
  padding: 6px;
  margin-top: 6px;
  max-height: 90px;
  overflow-y: auto;
}

.reason.plus { color: #14532d; font-weight: bold; }
.reason.minus { color: #b91c1c; font-weight: bold; }
.reason-time { font-size: 10px; color: #000; opacity: 0.7; margin-left: 4px; }

/* Badges */
.badge { margin-left: 6px; }
</style>
</head>

<body>

<button class="admin-btn" onclick="goAdmin()">Admin</button>

<div id="app"></div>

<script>
/* ğŸ”¥ FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDWrEqadNQ0ktZ9rIBG7yRequX_rstFFsE",
  authDomain: "online-tally-system.firebaseapp.com",
  databaseURL: "https://online-tally-system-default-rtdb.firebaseio.com",
  projectId: "online-tally-system",
  storageBucket: "online-tally-system.firebasestorage.app",
  messagingSenderId: "89585597340",
  appId: "1:89585597340:web:989e55802c4ebf68f6e659"
});

const db = firebase.database();
const app = document.getElementById("app");
let lastUndo = null;
let activeRef = null;

/* ROUTER */
function router() {
  const hash = location.hash;
  if (hash.startsWith("#grade")) {
    renderGrade(hash.split("-")[1]);
  } else if (hash === "#admin") {
    renderAdmin();
  } else {
    renderHome();
  }
}
window.addEventListener("hashchange", router);

/* HOME PAGE */
function renderHome() {
  app.innerHTML = `<ul id="grade-links"></ul>`;
  const ul = document.getElementById("grade-links");

  for (let g = 1; g <= 6; g++) {
    const li = document.createElement("li");
    ul.appendChild(li);

    if (activeRef) activeRef.off();
    const ref = db.ref(`grades/${g}`);
    ref.on("value", snap => {
      let max = 0;
      let leaders = [];
      snap.forEach(cls => {
        const p = cls.val()?.points || 0;
        if (p > max) {
          max = p;
          leaders = [cls.key];
        } else if (p === max && p > 0) {
          leaders.push(cls.key);
        }
      });

      let label = "";
      if (max > 0) {
        label = leaders.length > 1
          ? ` <span class="badge">ğŸ¥Š TIE</span> ${leaders.join(", ")}ë°˜ (${max})`
          : ` <span class="badge">ğŸ‘‘</span> ${leaders[0]}ë°˜ (${max})`;
      }

      li.innerHTML = `<a href="#grade-${g}">${g}í•™ë…„</a>${label}`;
    });
  }
}

/* GRADE PAGE */
function renderGrade(g) {
  app.innerHTML = `
    <h2>${g}í•™ë…„</h2>
    <div class="grid" id="grid"></div>
    <button onclick="location.hash=''">â† Home</button>
  `;

  const grid = document.getElementById("grid");

  if (activeRef) activeRef.off();
  activeRef = db.ref(`grades/${g}`);
  activeRef.on("value", snap => {
    grid.innerHTML = "";

    snap.forEach(cls => {
      const data = cls.val();
      const card = document.createElement("div");
      card.className = "card";

      const reasonsHTML = (data.reasons || []).slice(-3).map(r => `
        <div class="reason ${r.delta > 0 ? 'plus' : 'minus'}">
          ${r.text} <span class="reason-time">(${r.time})</span>
        </div>
      `).join("");

      card.innerHTML = `
        <div class="class-name">${cls.key}ë°˜</div>
        <div class="points">${data.points || 0}</div>
        <div class="reasons">${reasonsHTML}</div>
        <input id="r-${g}-${cls.key}" placeholder="ì´ìœ  ì…ë ¥">
        <button onclick="addPoint(${g},'${cls.key}',2)">+2</button>
        <button onclick="addPoint(${g},'${cls.key}',-1)">-1</button>
        ${lastUndo && lastUndo.g===Number(g) && lastUndo.c===cls.key ? `<button onclick="undo()">Undo</button>` : ""}
      `;

      grid.appendChild(card);
    });
  });
}

/* ADD POINT */
function addPoint(g, c, delta) {
  const input = document.getElementById(`r-${g}-${c}`);
  const text = input.value.trim();
  if (!text) return;

  const now = new Date();
  const time =
    String(now.getMonth() + 1).padStart(2, "0") + "." +
    String(now.getDate()).padStart(2, "0") + " " +
    String(now.getHours()).padStart(2, "0") + ":" +
    String(now.getMinutes()).padStart(2, "0");

  const ref = db.ref(`grades/${g}/${c}`);
  ref.transaction(d => {
    d ||= { points: 0, reasons: [] };
    d.points += delta;
    d.reasons.push({ text, delta, time });
    lastUndo = { g, c, delta };
    return d;
  });

  input.value = "";
}

/* UNDO */
function undo() {
  if (!lastUndo) return;
  const { g, c, delta } = lastUndo;

  db.ref(`grades/${g}/${c}`).transaction(d => {
    d.points -= delta;
    d.reasons.pop();
    return d;
  });

  lastUndo = null;
}

/* ADMIN */
function renderAdmin() {
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
  if (pw !== "delete") {
    location.hash = "";
    return;
  }

  app.innerHTML = `<h2>Admin Panel</h2>`;
  for (let g = 1; g <= 6; g++) {
    app.innerHTML += `<button onclick="clearGrade(${g})">${g}í•™ë…„ ì ìˆ˜ ì´ˆê¸°í™”</button><br>`;
  }
  app.innerHTML += `<br><button onclick="location.hash=''">Home</button>`;
}

function clearGrade(g) {
  if (!confirm("ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  db.ref(`grades/${g}`).remove();
}

function goAdmin() {
  location.hash = "#admin";
}

/* START */
router();
</script>

</body>
</html>
