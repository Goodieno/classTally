<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Class Tally</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
}

/* LINKS / BUTTONS */
a { color: #2563eb; text-decoration: none; font-size: 20px; }
button { cursor: pointer; margin: 4px; padding: 6px 10px; }

.admin-btn { position: fixed; top: 10px; right: 10px; }

/* GRID */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  max-width: 900px;
  margin: auto;
  gap: 15px;
}

/* CARD */
.card {
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 12px;
}

.class-name {
  color: #1d4ed8;
  font-weight: bold;
  font-size: 18px;
}

.points {
  color: #14532d;
  font-weight: bold;
  font-size: 22px;
}

/* REASONS */
.reasons {
  background: #f3f4f6;
  padding: 6px;
  margin: 6px 0;
  max-height: 90px;
  overflow-y: auto;
}

.reason.plus { color: #14532d; font-weight: bold; }
.reason.minus { color: #b91c1c; font-weight: bold; }
.reason-time { font-size: 10px; color: #000; margin-left: 4px; }

/* BADGES */
.badge { margin-left: 6px; }
</style>
</head>

<body>

<button class="admin-btn" onclick="goAdmin()">ê´€ë¦¬ì</button>
<div id="app"></div>

<script>
/* ğŸ”¥ FIREBASE INIT */
firebase.initializeApp({
  apiKey: "AIzaSyDWrEqadNQ0ktZ9rIBG7yRequX_rstFFsE",
  authDomain: "online-tally-system.firebaseapp.com",
  databaseURL: "https://online-tally-system-default-rtdb.firebaseio.com",
  projectId: "online-tally-system",
  storageBucket: "online-tally-system.firebasestorage.app",
  messagingSenderId: "89585597340",
  appId: "1:89585597340:web:989e55802c4ebf68f6e659"
});

const db = firebase.database();
const app = document.getElementById("app");
let activeRef = null;
let lastUndo = null;

/* SAFE LISTENER */
function listen(path, cb) {
  if (activeRef) activeRef.off();
  activeRef = db.ref(path);
  activeRef.on("value", snap => cb(snap.val() || {}));
}

/* ROUTER */
function router() {
  const h = location.hash;
  if (h.startsWith("#grade-")) renderGrade(h.split("-")[1]);
  else if (h === "#admin") renderAdmin();
  else renderHome();
}
window.addEventListener("hashchange", router);

/* HOME: show grades like 1í•™ë…„, 2í•™ë…„ */
function renderHome() {
  app.innerHTML = `<ul id="grade-links"></ul>`;
  const ul = document.getElementById("grade-links");

  for (let g = 1; g <= 6; g++) {
    const li = document.createElement("li");
    ul.appendChild(li);

    listen(`grades/${g}`, data => {
      let max = 0;
      let leaders = [];

      Object.entries(data).forEach(([cls, points]) => {
        const p = points || 0;
        if (p > max) { max = p; leaders = [cls]; }
        else if (p === max && p > 0) leaders.push(cls);
      });

      let badge = "";
      if (max > 0) {
        badge = leaders.length > 1
          ? ` <span class="badge">ğŸ¥Š ë™ì </span> ${leaders.join(", ")}ë°˜ (${max})`
          : ` <span class="badge">ğŸ‘‘</span> ${leaders[0]}ë°˜ (${max})`;
      }

      li.innerHTML = `<a href="#grade-${g}">${g}í•™ë…„</a>${badge}`;
    });
  }
}

/* GRADE PAGE: show full name like "1í•™ë…„ 1ë°˜" */
function renderGrade(g) {
  app.innerHTML = `<h2>${g}í•™ë…„</h2><div class="grid" id="grid"></div><button onclick="location.hash=''">â† í™ˆìœ¼ë¡œ</button>`;
  const grid = document.getElementById("grid");

  listen(`classes/${g}`, data => {
    grid.innerHTML = "";
    Object.entries(data).forEach(([cls, val]) => {
      const clsData = val || { points: 0, reasons: [] };
      const reasonsHTML = (clsData.reasons || []).slice(-3).map(r => `
        <div class="reason ${r.delta>0?'plus':'minus'}">
          ${r.text} <span class="reason-time">(${r.time})</span>
        </div>
      `).join("");

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="class-name">${g}í•™ë…„ ${cls}ë°˜</div>
        <div class="points">${clsData.points}</div>
        <div class="reasons">${reasonsHTML}</div>
        <input id="r-${g}-${cls}" placeholder="ì´ìœ  ì…ë ¥">
        <button onclick="addPoint('${g}','${cls}',1)">+1ì </button>
        <button onclick="addPoint('${g}','${cls}',-1)">-1ì </button>
        ${lastUndo ? `<button onclick="undo()">ì‹¤í–‰ ì·¨ì†Œ</button>` : ""}
      `;
      grid.appendChild(card);
    });
  });
}

/* ADD POINT */
function addPoint(grade, cls, delta) {
  const input = document.getElementById(`r-${grade}-${cls}`);
  const text = input.value.trim();
  if (!text) return;

  const now = new Date();
  const time =
    String(now.getMonth()+1).padStart(2,"0")+"."+
    String(now.getDate()).padStart(2,"0")+" "+
    String(now.getHours()).padStart(2,"0")+":"+
    String(now.getMinutes()).padStart(2,"0");

  const classRef = db.ref(`classes/${grade}/${cls}`);
  classRef.transaction(d => {
    d ||= { points:0, reasons:[] };
    d.points += delta;
    d.reasons.push({ text, delta, time });
    lastUndo = { grade, cls, delta };
    return d;
  }).then(() => {
    classRef.once("value").then(snap => {
      const points = snap.val().points || 0;
      db.ref(`grades/${grade}/${cls}`).set(points);
    });
  });

  input.value = "";
}

/* UNDO */
function undo() {
  if (!lastUndo) return;
  const { grade, cls, delta } = lastUndo;

  const classRef = db.ref(`classes/${grade}/${cls}`);
  classRef.transaction(d => {
    d.points -= delta;
    d.reasons.pop();
    return d;
  }).then(() => {
    classRef.once("value").then(snap => {
      const points = snap.val().points || 0;
      db.ref(`grades/${grade}/${cls}`).set(points);
    });
  });

  lastUndo = null;
}

/* ADMIN */
function renderAdmin() {
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
  if (pw !== "delete") { location.hash=""; return; }

  app.innerHTML = `<h2>ê´€ë¦¬ì íŒ¨ë„</h2>`;
  for(let g=1; g<=6; g++){
    app.innerHTML += `<button onclick="clearGrade(${g})">${g}í•™ë…„ ì ìˆ˜ ì´ˆê¸°í™”</button><br>`;
  }
  app.innerHTML += `<br><button onclick="location.hash=''">í™ˆìœ¼ë¡œ</button>`;
}

function clearGrade(g){
  if(!confirm("ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  db.ref(`classes/${g}`).remove();
  db.ref(`grades/${g}`).remove();
}

function goAdmin(){ location.hash="#admin"; }

/* START */
router();
</script>

</body>
</html>
